(()=>{"use strict";window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="any",t=document.querySelector(".map__filters").querySelectorAll("select"),o=(o,r)=>{let n,l=!0;return o.offer.price<1e4?n="low":o.offer.price>=1e4&&o.offer.price<=5e4?n="middle":o.offer.price>5e4&&(n="high"),t[0].value!==o.offer.type&&t[0].value!==e&&(l=!1),t[1].value!==n&&t[1].value!==e&&(l=!1),+t[2].value!==o.offer.rooms&&t[2].value!==e&&(l=!1),+t[3].value!==o.offer.guests&&t[3].value!==e&&(l=!1),r.forEach((e=>{-1===o.offer.features.indexOf(e.value)&&e.classList.contains("checked")&&(l=!1)})),l?o:null};window.render={ads:(e,t=[])=>{let r=[];for(let n=0;n<e.length;n++){let l=o(e[n],t);if(null!==l&&r.push(l),5===r.length)break}return r}}})(),(()=>{const e=document.querySelector("#server-error"),t=document.querySelector("#success"),o=document.querySelector(".map"),r=t=>{let r=e.content.cloneNode(!0);r.querySelector(".error__message").textContent="Произошла ошибка! "+t,r.querySelector(".error__button").addEventListener("click",(e=>{e.preventDefault(),location.reload(!0)})),o.appendChild(r)},n=e=>{"Escape"===e.key&&a(e)},l=e=>{0===e.button&&a(e)},a=e=>{e.preventDefault();let t=document.querySelector(".error");t&&t.remove();let o=document.querySelector(".success");o&&o.remove(),o.remove(),document.removeEventListener("keydown",n),document.removeEventListener("mousedown",l)},d=(e,t=(()=>{}))=>{e.responseType="json",e.addEventListener("load",(()=>{let o;switch(e.status){case 200:t(e.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o="Cтатус ответа: : "+e.status+" "+e.statusText}o&&r(o)})),e.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e3};window.backend={load:e=>{let t=new XMLHttpRequest;d(t,e),t.open("GET","https://21.javascript.pages.academy/keksobooking/data"),t.send()},upload:(e,t)=>{let o=new XMLHttpRequest;d(o,t),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},uploadSuccess:()=>{let e=t.content.cloneNode(!0);o.appendChild(e),document.addEventListener("keydown",n),document.addEventListener("mousedown",l)}}})(),(()=>{const e={BUNGALOW:"Бунгало",PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом"},t={WIDTH:"45",HEIGHT:"40"},o=e=>{if("Escape"===e.key){let e=document.querySelector(".map__card");e&&e.remove(),document.removeEventListener("keydown",o)}},r=document.querySelector("#card");window.card={generateAd:n=>{let l=r.content.cloneNode(!0),a=l.querySelectorAll(".popup__feature");return l.querySelector(".popup__title").textContent=n.offer.title,l.querySelector(".popup__text--address").textContent=n.offer.address,l.querySelector(".popup__text--price").textContent=n.offer.price+"₽/ночь",l.querySelector(".popup__type").textContent=e[n.offer.type.toUpperCase()],l.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,l.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,((e,t,o)=>{if(o.length)for(let e=0;e<t.length;e++){let r=0;for(let n=0;n<o.length&&!1===t[e].classList.contains("popup__feature--"+o[n]);n++)r++,r===o.length&&t[e].remove()}else e.querySelector(".popup__features").remove()})(l,a,n.offer.features),((e,o)=>{let r=e.querySelector(".popup__photos"),n=e.querySelector(".popup__photo");if(o.length)for(let e=0;e<o.length;e++)if(0===e)n.src=o[e];else{let n=document.createElement("img");n.width=t.WIDTH,n.height=t.height,n.classList.add("popup__photo"),n.src=o[e],n.alt="Фотография жилья",r.appendChild(n)}else r.remove()})(l,n.offer.photos),l.querySelector(".popup__description").textContent=n.offer.description,l.querySelector(".popup__avatar").src=n.author.avatar,document.addEventListener("keydown",o),l}}})(),(()=>{const e="Enter",t=document.querySelector(".map__pins"),o=document.querySelector("#pin"),r=document.querySelector(".map"),n=document.querySelector(".map__filters-container"),l=document.querySelector(".map__pin--main"),a=document.querySelector(".ad-form"),d=document.querySelector(".map__filters"),s=document.querySelector("#address"),c=d.querySelectorAll("select"),u=d.querySelectorAll("#housing-features input"),i=document.querySelector(".ad-form-header__preview img"),p=document.querySelector(".ad-form__photo");let m;const f=()=>{w(),window.debounce(window.map.generatePins(window.render.ads(m)))};c.forEach((e=>{e.addEventListener("change",f)})),u.forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("checked"),w(),window.debounce(window.map.generatePins(window.render.ads(m,u)))}))}));const y=e=>{let t=e.style.left=parseInt(e.style.left,10),o=e.style.top=parseInt(e.style.top,10);s.value=`${t}, ${o}`};y(l);const v=e=>{let t=parseInt(e.style.left,10)+33,o=parseInt(e.style.top,10)+12;s.value=`${t}, ${o}`},w=()=>{let e=document.querySelector(".popup");e&&e.remove()},h=(e,t)=>{w(),r.insertBefore(window.card.generateAd(t[e]),n);let o=document.querySelector(".popup");o.querySelector(".popup__close").addEventListener("click",(e=>{e.preventDefault(),o.remove()}))},_=()=>{let e=t.querySelectorAll("button:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},S=t=>{t.key!==e&&0!==t.button||(r.classList.remove("map--faded"),window.backend.load((e=>{window.map.generatePins(window.render.ads(e,u)),m=e})),window.form.checkAdFormTypeSelect(),window.form.checkRoomNumberCapacity(),window.form.controlInputs(!0),v(l),l.removeEventListener("keydown",S),l.removeEventListener("mousedown",S))};l.addEventListener("keydown",S),l.addEventListener("mousedown",S),window.map={generatePins:r=>{_();let n=document.createDocumentFragment();for(let t=0;t<r.length;t++){let l=o.content.cloneNode(!0),a=l.querySelector(".map__pin"),d=l.querySelector(".map__pin img");a.style.left=r[t].location.x+"px",a.style.top=r[t].location.y+"px",d.src=r[t].author.avatar,d.alt=r[t].offer.title,n.appendChild(l),a.addEventListener("click",(o=>{0!==o.button&&o.key!==e||h(t,r)}))}t.appendChild(n)},getLocation:v,disable:()=>{r.classList.add("map--faded"),window.form.controlInputs(!1),_(),v(l),w(),l.addEventListener("keydown",S),l.addEventListener("mousedown",S),a.reset(),d.reset(),l.style.left="570px",l.style.top="375px",y(l),p.style.backgroundImage="none",i.src="img/muffin-grey.svg"}}})(),(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault();let r=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.offsetLeft-r>=-33&&e.offsetLeft-r<=1167&&(e.style.left=e.offsetLeft-r+"px"),e.offsetTop-n>=93&&e.offsetTop-n<=593&&(e.style.top=e.offsetTop-n+"px"),window.map.getLocation(e)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)}))})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t={1:[2],2:[1,2],3:[0,1,2],100:[3]},o=["gif","jpg","jpeg","png"],r=document.querySelector("#title"),n=document.querySelector("#price"),l=document.querySelector("#type"),a=document.querySelector("#timein"),d=a.querySelectorAll("option"),s=document.querySelector("#timeout"),c=s.querySelectorAll("option"),u=document.querySelector(".ad-form"),i=document.querySelector(".ad-form__reset"),p=document.querySelector("#room_number"),m=document.querySelector("#capacity").querySelectorAll("option"),f=document.querySelectorAll(".map__filter"),y=document.querySelector(".map__features"),v=document.querySelector(".ad-form-header"),w=document.querySelectorAll(".ad-form__element"),h=document.querySelector("#avatar"),_=document.querySelector(".ad-form-header__preview img"),S=document.querySelector("#images"),q=document.querySelector(".ad-form__photo"),b=()=>{let t=l.value;n.placeholder=e[t],n.setAttribute("min",e[t])},g=()=>{let e=p.value;m.forEach((e=>{e.setAttribute("disabled","disabled")})),t[+e].forEach((e=>{m[e].removeAttribute("disabled"),m[e].selected="selected"}))},L=e=>{e?(u.classList.remove("ad-form--disabled"),v.removeAttribute("disabled"),y.removeAttribute("disabled"),f.forEach((e=>{e.removeAttribute("disabled")})),w.forEach((e=>{e.removeAttribute("disabled")}))):(u.classList.add("ad-form--disabled"),v.setAttribute("disabled","disabled"),y.setAttribute("disabled","disabled"),f.forEach((e=>{e.setAttribute("disabled","disabled")})),w.forEach((e=>{e.setAttribute("disabled","disabled")})))};r.addEventListener("input",(()=>{let e=r.value.length;e<30?r.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?r.setCustomValidity("Удалите лишние "+(e-100)+" симв."):r.setCustomValidity(""),r.reportValidity()})),n.addEventListener("input",(()=>{let t=n.value,o=l.value;t>1e6?n.setCustomValidity("Вы не можете ввести значение превышающее 1000000"):n.validity.valueMissing?n.setCustomValidity("Введите стоимость проживания за ночь"):n.setCustomValidity(""),"bungalow"===o&&t<e.bungalow?n.setCustomValidity("Вы не можете ввести значение ниже "+e.bungalow):"flat"===o&&t<e.flat?n.setCustomValidity("Вы не можете ввести значение ниже "+e.flat):"house"===o&&t<e.house?n.setCustomValidity("Вы не можете ввести значение ниже "+e.house):"palace"===o&&t<e.palace&&n.setCustomValidity("Вы не можете ввести значение ниже "+e.palace),b(),n.reportValidity()})),l.addEventListener("change",(()=>{b()}));const E=e=>{let t;t=e?a.value:s.value;for(let e=0;e<c.length;e++)c[e].removeAttribute("selected"),d[e].removeAttribute("selected"),c[e].value===t&&(c[e].selected="selected",d[e].selected="selected")};a.addEventListener("change",(()=>{E(!0)})),s.addEventListener("change",(()=>{E(!1)})),p.addEventListener("change",(()=>{g()})),L(!1),u.addEventListener("submit",(e=>{window.backend.upload(new FormData(u),(()=>{window.backend.uploadSuccess(),window.map.disable()})),e.preventDefault()})),h.addEventListener("change",(()=>{let e=h.files[0],t=e.name.toLowerCase();if(o.some((e=>t.endsWith(e)))){let t=new FileReader;t.addEventListener("load",(()=>{_.src=t.result})),t.readAsDataURL(e)}})),S.addEventListener("change",(()=>{let e=S.files[0],t=e.name.toLowerCase();if(o.some((e=>t.endsWith(e)))){let t=new FileReader;t.addEventListener("load",(()=>{q.style.backgroundSize="cover",q.style.backgroundImage=`url(${t.result})`})),t.readAsDataURL(e)}})),i.addEventListener("click",window.map.disable),window.form={checkAdFormTypeSelect:b,checkRoomNumberCapacity:g,controlInputs:L}})()})();