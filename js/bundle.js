(()=>{"use strict";window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll("select"),o=(e.querySelectorAll("#housing-features input"),(e,o)=>{let r,n=!0;return e.offer.price<1e4?r="low":e.offer.price>=1e4&&e.offer.price<=5e4?r="medium":e.offer.price>5e4&&(r="high"),t[0].value!==e.offer.type&&"any"!==t[0].value&&(n=!1),t[1].value!==r&&"any"!==t[1].value&&(n=!1),t[2].value!==e.offer.rooms&&"any"!==t[2].value&&(n=!1),t[3].value!==e.offer.guests&&"any"!==t[3].value&&(n=!1),o.forEach((t=>{-1===e.offer.features.indexOf(t.value)&&t.classList.contains("checked")&&(n=!1)})),n?e:null});window.render={ads:(e,t=[])=>{let r=[];for(let n=0;n<e.length;n++){let l=o(e[n],t);if(null!==l&&r.push(l),5===r.length)break}return r}}})(),(()=>{const e=(document.querySelector("#error"),document.querySelector("#server-error")),t=document.querySelector("#success"),o=document.querySelector(".map"),r=t=>{let r=e.content.cloneNode(!0);r.querySelector(".error__message").textContent="Произошла ошибка! "+t,r.querySelector(".error__button").addEventListener("click",(e=>{e.preventDefault(),location.reload(!0)})),o.appendChild(r)},n=e=>{"Escape"===e.key&&d(e)},l=e=>{1===e.which&&d(e)},d=e=>{e.preventDefault();let t=document.querySelector(".error");null!==t&&t.remove();let o=document.querySelector(".success");null!==o&&o.remove(),o.remove(),document.removeEventListener("keydown",n),document.removeEventListener("mousedown",l)},a=(e,t=(()=>{}))=>{e.responseType="json",e.addEventListener("load",(o=>{let n;switch(e.status){case 200:t(e.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;default:n="Cтатус ответа: : "+e.status+" "+e.statusText}n&&r(n)})),e.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e3};window.backend={load:e=>{let t=new XMLHttpRequest;a(t,e),t.open("GET","https://21.javascript.pages.academy/keksobooking/data"),t.send()},upload:(e,t)=>{let o=new XMLHttpRequest;a(o,t),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},uploadSuccess:()=>{let e=t.content.cloneNode(!0);o.appendChild(e),document.addEventListener("keydown",n),document.addEventListener("mousedown",l)}}})(),(()=>{const e={bugalow:"Бунгало",palace:"Дворец",flat:"Квартира",house:"Дом"},t=e=>{let o=document.querySelector(".map__card");null!==o&&o.remove(),document.removeEventListener("keydown",t)},o=document.querySelector("#card");window.card={generateAd:r=>{let n=o.content.cloneNode(!0),l=n.querySelectorAll(".popup__feature");return n.querySelector(".popup__title").textContent=r.offer.title,n.querySelector(".popup__text--address").textContent=r.offer.address,n.querySelector(".popup__text--price").textContent=r.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=e[r.offer.type],n.querySelector(".popup__text--capacity").textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`,((e,t,o)=>{if(o.length>0)for(let e=0;e<t.length;e++){let r=0;for(let n=0;n<o.length&&!1===t[e].classList.contains("popup__feature--"+o[n]);n++)r++,r===o.length&&t[e].remove()}else e.querySelector(".popup__features").remove()})(n,l,r.offer.features),((e,t)=>{let o=e.querySelector(".popup__photos"),r=e.querySelector(".popup__photo");if(t.length>0)for(let e=0;e<t.length;e++)if(0===e)r.src=t[e];else{let r=document.createElement("img");r.width="45",r.height="40",r.classList.add("popup__photo"),r.src=t[e],r.alt="Фотография жилья",o.appendChild(r)}else o.remove()})(n,r.offer.photos),n.querySelector(".popup__description").textContent=r.offer.description,n.querySelector(".popup__avatar").src=r.author.avatar,document.addEventListener("keydown",t),n}}})(),(()=>{const e="Enter",t=document.querySelector(".map__pins"),o=document.querySelector("#pin"),r=document.querySelector(".map"),n=(document.querySelector("#card"),document.querySelector(".map__filters-container")),l=document.querySelector(".map__pin--main"),d=document.querySelector(".ad-form"),a=document.querySelector(".map__filters"),c=document.querySelector("#address"),u=(document.querySelector("#title"),document.querySelector("#price"),a.querySelectorAll("select")),s=a.querySelectorAll("#housing-features input"),i=document.querySelector(".ad-form-header__preview img"),m=document.querySelector(".ad-form__photo");let p;const f=()=>{w(),window.debounce(window.map.generatePins(window.render.ads(p)))};u.forEach((e=>{e.addEventListener("change",f)})),s.forEach((e=>{e.addEventListener("click",(()=>{e.classList.toggle("checked"),w(),window.debounce(window.map.generatePins(window.render.ads(p,s)))}))}));const y=e=>{let t=e.style.left=parseInt(e.style.left,10),o=e.style.top=parseInt(e.style.top,10);c.value=`${t}, ${o}`};y(l);const v=e=>{let t=parseInt(e.style.left,10)+33,o=parseInt(e.style.top,10)+12;c.value=`${t}, ${o}`},w=()=>{let e=document.querySelector(".popup");null!==e&&e.remove()},S=(e,t)=>{w();let o=document.querySelector(".popup");r.insertBefore(window.card.generateAd(t[e]),n),o=document.querySelector(".popup"),o.querySelector(".popup__close").addEventListener("click",(e=>{e.preventDefault(),o.remove()}))},h=()=>{let e=t.querySelectorAll("button:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},q=t=>{t.key!==e&&1!==t.which||(r.classList.remove("map--faded"),window.backend.load((e=>{window.map.generatePins(window.render.ads(e,s)),p=e})),window.form.checkAdFormTypeSelect(),window.form.checkRoomNumberCapacity(),window.form.controlInputs(!0),v(l),l.removeEventListener("keydown",q),l.removeEventListener("mousedown",q))};l.addEventListener("keydown",q),l.addEventListener("mousedown",q),window.map={generatePins:r=>{h();let n=document.createDocumentFragment();for(let t=0;t<r.length;t++){let l=o.content.cloneNode(!0),d=l.querySelector(".map__pin"),a=l.querySelector(".map__pin img");d.style.left=r[t].location.x+"px",d.style.top=r[t].location.y+"px",a.src=r[t].author.avatar,a.alt=r[t].offer.title,n.appendChild(l),d.addEventListener("mousedown",(e=>{e.preventDefault(),S(t,r)})),d.addEventListener("keydown",(o=>{o.key===e&&S(t,r)}))}t.appendChild(n)},getLocation:v,disable:()=>{r.classList.add("map--faded"),window.form.controlInputs(!1),h(),v(l),w(),l.addEventListener("keydown",q),l.addEventListener("mousedown",q),d.reset(),a.reset(),l.style.left="570px",l.style.top="375px",y(l),m.style.backgroundImage="none",i.src="img/muffin-grey.svg"}}})(),(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault();let r=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.offsetLeft-r>=-33&&e.offsetLeft-r<=1167&&(e.style.left=e.offsetLeft-r+"px"),e.offsetTop-n>=93&&e.offsetTop-n<=593&&(e.style.top=e.offsetTop-n+"px"),window.map.getLocation(e)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)}))})(),(()=>{const e={1:[2],2:[1,2],3:[0,1,2],100:[3]},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=["gif","jpg","jpeg","png"],r=(document.querySelector(".map"),document.querySelector("#title")),n=document.querySelector("#price"),l=document.querySelector("#type"),d=document.querySelector("#timein"),a=d.querySelectorAll("option"),c=document.querySelector("#timeout"),u=c.querySelectorAll("option"),s=document.querySelector(".ad-form"),i=document.querySelector(".ad-form__reset"),m=document.querySelector("#room_number"),p=(m.querySelectorAll("option"),document.querySelector("#capacity").querySelectorAll("option")),f=(document.querySelector(".map__filters"),document.querySelectorAll(".map__filter")),y=document.querySelector(".map__features"),v=document.querySelector(".ad-form-header"),w=document.querySelectorAll(".ad-form__element"),S=document.querySelector("#avatar"),h=document.querySelector(".ad-form-header__preview img"),q=document.querySelector("#images"),_=document.querySelector(".ad-form__photo"),L=()=>{let e=l.value;n.placeholder=t[e],n.setAttribute("min",t[e])},g=()=>{let t=m.value;p.forEach((e=>{e.setAttribute("disabled","disabled")})),e[+t].forEach((e=>{p[e].removeAttribute("disabled"),p[e].selected="selected"}))},b=e=>{e?(s.classList.remove("ad-form--disabled"),v.removeAttribute("disabled"),y.removeAttribute("disabled"),f.forEach((e=>{e.removeAttribute("disabled")})),w.forEach((e=>{e.removeAttribute("disabled")}))):(s.classList.add("ad-form--disabled"),v.setAttribute("disabled","disabled"),y.setAttribute("disabled","disabled"),f.forEach((e=>{e.setAttribute("disabled","disabled")})),w.forEach((e=>{e.setAttribute("disabled","disabled")})))};r.addEventListener("input",(()=>{let e=r.value.length;e<30?r.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?r.setCustomValidity("Удалите лишние "+(e-100)+" симв."):r.setCustomValidity(""),r.reportValidity()})),n.addEventListener("input",(()=>{let e=n.value,o=l.value;e>1e6?n.setCustomValidity("Вы не можете ввести значение превышающее 1000000"):n.validity.valueMissing?n.setCustomValidity("Введите стоимость проживания за ночь"):n.setCustomValidity(""),"bungalow"===o&&e<t.BUNGALOW?n.setCustomValidity("Вы не можете ввести значение ниже "+t.BUNGALOW):"flat"===o&&e<t.FLAT?n.setCustomValidity("Вы не можете ввести значение ниже "+t.FLAT):"house"===o&&e<t.HOUSE?n.setCustomValidity("Вы не можете ввести значение ниже "+t.HOUSE):"palace"===o&&e<t.PALACE&&n.setCustomValidity("Вы не можете ввести значение ниже "+t.PALACE),L(),n.reportValidity()})),l.addEventListener("change",(()=>{L()}));const E=e=>{let t;t=e?d.value:c.value;for(let e=0;e<u.length;e++)u[e].removeAttribute("selected"),a[e].removeAttribute("selected"),u[e].value===t&&(u[e].selected="selected",a[e].selected="selected")};d.addEventListener("change",(()=>{E(!0)})),c.addEventListener("change",(()=>{E(!1)})),m.addEventListener("change",(()=>{g()})),b(!1),s.addEventListener("submit",(e=>{window.backend.upload(new FormData(s),(()=>{window.backend.uploadSuccess(),window.map.disable()})),e.preventDefault()})),S.addEventListener("change",(()=>{let e=S.files[0],t=e.name.toLowerCase();if(o.some((e=>t.endsWith(e)))){let t=new FileReader;t.addEventListener("load",(()=>{h.src=t.result})),t.readAsDataURL(e)}})),q.addEventListener("change",(()=>{let e=q.files[0],t=e.name.toLowerCase();if(o.some((e=>t.endsWith(e)))){let t=new FileReader;t.addEventListener("load",(()=>{_.style.backgroundSize="cover",_.style.backgroundImage=`url(${t.result})`})),t.readAsDataURL(e)}})),i.addEventListener("click",window.map.disable),window.form={checkAdFormTypeSelect:L,checkRoomNumberCapacity:g,controlInputs:b}})()})();